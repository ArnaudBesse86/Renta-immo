<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur de rentabilité d'investissement locatif</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md mt-10">
        <div id="userInfo" class="text-right mb-4">
            <span id="userName"></span>
            <button id="logoutButton" class="ml-2 text-blue-500" style="display: none;">Se déconnecter</button>
        </div>
        
        <div id="authContainer">
            <div id="loginContainer">
                <h2 id="connexion" class="text-xl font-bold mb-4">Connexion</h2>
                <input type="email" id="loginEmail" placeholder="Email" class="mb-2 p-2 border rounded w-full">
                <input type="password" id="loginPassword" placeholder="Mot de passe" class="mb-2 p-2 border rounded w-full">
                <button onclick="login()" class="bg-blue-500 text-white p-2 rounded w-full">Se connecter</button>
                <p class="mt-2">Pas encore de compte ? <a href="#" class="text-blue-500" onclick="showRegister()">S'inscrire</a></p>
            </div>

            <div id="registerContainer" style="display: none;">
                <h2 id="création-de-compte" class="text-xl font-bold mb-4">Création de compte</h2>
                <input type="text" id="registerFirstName" placeholder="Prénom" class="mb-2 p-2 border rounded w-full">
                <input type="text" id="registerLastName" placeholder="Nom" class="mb-2 p-2 border rounded w-full">
                <input type="email" id="registerEmail" placeholder="Email" class="mb-2 p-2 border rounded w-full">
                <input type="password" id="registerPassword" placeholder="Mot de passe" class="mb-2 p-2 border rounded w-full">
                <button onclick="register()" class="bg-green-500 text-white p-2 rounded w-full">Créer un compte</button>
                <p class="mt-2">Déjà un compte ? <a href="#" class="text-blue-500" onclick="showLogin()">Se connecter</a></p>
            </div>
        </div>

        <div id="calculatorContainer" style="display: none;">
            <h2 class="text-2xl font-bold mb-6">Calculateur de rentabilité d'investissement locatif</h2>
            <div>
                <label for="propertyPrice">Prix du bien (€)</label>
                <input type="number" id="propertyPrice" class="w-full border p-2 mb-2" oninput="calculateNotaryFees(); calculateLoanAmount()" >
            </div>
            <div>
                <label for="notaryFees">Frais de notaire (€)</label>
                <input type="number" id="notaryFees" class="w-full border p-2 mb-2" oninput="calculateLoanAmount()">
            </div>
            <div>
                <label>
                    <input type="checkbox" id="noLoan" onchange="toggleLoanFields()"> Sans emprunt
                </label>
            </div>
            <div id="loanFields">
                <div>
                    <label for="downPayment">Apport (€)</label>
                    <input type="number" id="downPayment" class="w-full border p-2 mb-2" oninput="calculateLoanAmount()">
                </div>
                <div>
                    <label for="loanAmount">Montant a emprunter (€)</label>
                    <input type="number" id="loanAmount" class="w-full border p-2 mb-2">
                </div>
                <div>
                    <label for="loanDuration">Durée de l'emprunt (années)</label>
                    <input type="number" id="loanDuration" class="w-full border p-2 mb-2">
                </div>
                <div>
                    <label for="interestRate">Taux d'intérêt annuel (%)</label>
                    <input type="number" id="interestRate" step="0.1" class="w-full border p-2 mb-2" value="3.5">
                </div>
            </div>
            <div>
                <label for="monthlyRent">Loyer mensuel estimé (€)</label>
                <input type="number" id="monthlyRent" class="w-full border p-2 mb-2">
            </div>
            <div>
                <label for="propertyTax">Taxe foncière annuelle (€)</label>
                <input type="number" id="propertyTax" class="w-full border p-2 mb-2">
            </div>
            <div>
                <label for="coownershipCharges">Charges de copropriété annuelles (€)</label>
                <input type="number" id="coownershipCharges" class="w-full border p-2 mb-2">
            </div>
            <div>
                <label for="insurance">Assurance annuelle (€)</label>
                <input type="number" id="insurance" class="w-full border p-2 mb-2">
            </div>
            <div>
                <label for="managementFees">Frais de gestion locative (%)</label>
                <input type="number" id="managementFees" step="0.1" class="w-full border p-2 mb-2">
            </div>
            <button onclick="calculateProfitability()" class="bg-blue-500 text-white px-4 py-2 rounded">Calculer la rentabilité</button>
        </div>

        <div id="resultat" class="mt-6 p-4 bg-gray-200 rounded" style="display: none;">
            <h3 id="résultats" class="text-xl font-semibold mb-2">Résultats :</h3>
            <div id="resultatsContenu"></div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAvdnnSLFslpEGuMiNG_N0BePMNJ0lOqnQ",
            authDomain: "https://rentabilite-immo.firebaseapp.com",
            projectId: "rentabilite-immo",
            storageBucket: "gs://rentabilite-immo.appspot.com",
            //messagingSenderId: "79218113340",
           // appId: "1:79218113340:web:6b2c952af5c4c7add07c39",
            //measurementId: "G-VQCNFHWV5Q"
            // ... autres configurations
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Références aux éléments du DOM
        const userNameElement = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');

        // Fonction pour afficher le nom de l'utilisateur
        async function displayUserInfo(user) {
            if (user) {
                try {
                    const docRef = doc(db, 'utilisateurs', user.uid);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        userNameElement.textContent = `${userData.prenom} ${userData.nom} ${userData.email}`;
                        logoutButton.style.display = 'inline-block';
                        document.getElementById('authContainer').style.display = 'none';
                        document.getElementById('calculatorContainer').style.display = 'block';
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération des données utilisateur:", error);
                }
            } else {
                userNameElement.textContent = '';
                logoutButton.style.display = 'none';
                document.getElementById('authContainer').style.display = 'block';
                document.getElementById('calculatorContainer').style.display = 'none';
            }
        }

        // Écouter les changements d'état d'authentification
        onAuthStateChanged(auth, (user) => {
            displayUserInfo(user);
        });

        // Gestion de la déconnexion
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log('Utilisateur déconnecté');
            }).catch((error) => {
                console.error('Erreur lors de la déconnexion:', error);
            });
        });
        
         // Fonction de connexion
         window.login = function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Connexion réussie
                    const user = userCredential.user;
                    console.log('Utilisateur connecté:', user);
                    showCalculator();
                    console.log('Utilisateur connecté:', user.email);
                    //userNameElement.textContent = `${user.email}`;
                    //logoutButton.style.display = 'inline-block';
                })
                .catch((error) => {
                    console.error('Erreur de connexion:', error);
                    alert('Erreur de connexion: ' + error.message);
                    showLogin();
                });
        }
         // Fonction d'inscription
         window.register = function() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const prenom = document.getElementById('registerFirstName').value;
            const nom = document.getElementById('registerLastName').value;

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Inscription réussie
                    const user = userCredential.user;
                    // Ajouter les informations supplémentaires à Firestore
                    return setDoc(doc(db, 'utilisateurs', user.uid), {
                        prenom: prenom,
                        nom: nom,
                        email: email,
                        password: password
                    });
                })
                .then(() => {
                    console.log('Utilisateur inscrit et données ajoutées à Firestore');
                })
                .catch((error) => {
                    console.error('Erreur d\'inscription:', error);
                    alert('Erreur d\'inscription: ' + error.message);
                });
        }


        // Fonction pour afficher le formulaire de connexion
        window.showLogin = function() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('registerContainer').style.display = 'none';
        }

        // Fonction pour afficher le formulaire d'inscription
        window.showRegister = function() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('registerContainer').style.display = 'block';
        }

        function showCalculator() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('calculatorContainer').style.display = 'block';
        }

        // Vérifier l'état de l'authentification au chargement de la page
       /* firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // L'utilisateur est connecté
                showCalculator();
            } else {
                // L'utilisateur n'est pas connecté
                showLogin();
            }
        });*/

        // Ajouter ici les autres fonctions JS nécessaires pour le calculateur
        window.toggleLoanFields = function() {
            const loanFields = document.getElementById('loanFields');
            const noLoan = document.getElementById('noLoan');
            loanFields.style.display = noLoan.checked ? 'none' : 'block';
        }

        window.calculateNotaryFees = function() {
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            let notaryFees;
            notaryFees = propertyPrice * 8/100;
            /*if (propertyPrice <= 6500) {
                notaryFees = propertyPrice * 0.0385;
            } else if (propertyPrice <= 17000) {
                notaryFees = propertyPrice * 0.0165 + 143.75;
            } else if (propertyPrice <= 60000) {
                notaryFees = propertyPrice * 0.011 + 236.25;
            } else {
                notaryFees = propertyPrice * 0.00825 + 406.25;
            }*/
            document.getElementById('notaryFees').value = notaryFees.toFixed(2);
        }

        window.calculateLoanAmount = function() {
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            const notaryFees = parseFloat(document.getElementById('notaryFees').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            let loanAmount;
            loanAmount = propertyPrice + notaryFees - downPayment;
            
            document.getElementById('loanAmount').value = loanAmount.toFixed(2);
        
        }


        window.calculateProfitability = function() {
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            const notaryFees = parseFloat(document.getElementById('notaryFees').value) || 0;
            const noLoan = document.getElementById('noLoan').checked;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const loanDuration = parseFloat(document.getElementById('loanDuration').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 0;
            const propertyTax = parseFloat(document.getElementById('propertyTax').value) || 0;
            const coownershipCharges = parseFloat(document.getElementById('coownershipCharges').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const managementFees = parseFloat(document.getElementById('managementFees').value) || 0;

            let monthlyLoanPayment = 0;
            if (!noLoan) {
                const monthlyRate = interestRate / 100 / 12;
                const numberOfPayments = loanDuration * 12;
                monthlyLoanPayment = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
            }

            const totalInvestment = propertyPrice + notaryFees;
            const annualRent = monthlyRent * 12;
            const annualCharges = propertyTax + coownershipCharges + insurance + (annualRent * managementFees / 100);
            const annualCashFlow = annualRent - annualCharges - (monthlyLoanPayment * 12);

            const grossYield = (annualRent / totalInvestment) * 100;
            const netYield = (annualCashFlow / totalInvestment) * 100;

            const resultatDiv = document.getElementById('resultat');
            const resultatsContenu = document.getElementById('resultatsContenu');
            resultatsContenu.innerHTML = `
                <p>Investissement total : ${totalInvestment.toFixed(2)} €</p>
                <p>Loyers annuels : ${annualRent.toFixed(2)} €</p>
                <p>Charges annuelles : ${annualCharges.toFixed(2)} €</p>
                <p>Mensualité du prêt : ${monthlyLoanPayment.toFixed(2)} €</p>
                <p>Cash-flow annuel : ${annualCashFlow.toFixed(2)} €</p>
                <p>Rentabilité brute : ${grossYield.toFixed(2)}%</p>
                <p>Rentabilité nette : ${netYield.toFixed(2)}%</p>
            `;
            resultatDiv.style.display = 'block';
        }

        // Initialisation
        window.onload = function() {
            toggleLoanFields();
            calculateNotaryFees();
            calculateLoanAmount();
        }


    </script>
</body>
</html>
